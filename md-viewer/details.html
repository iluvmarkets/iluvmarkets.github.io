<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Analysis</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
  body {
    font-family: sans-serif;
    font-size: 14px; /* Slightly smaller font */
    padding: 2rem;
    max-width: 800px;
    margin: auto;
    background-color: #f9f9f9;
  }

  /* Banner styles */
  .company-banner {
    background-color: #007bff; /* Blue background */
    color: white;
    padding: 1rem;
    text-align: center;
    margin-bottom: 2rem;
    border-radius: 8px;
    font-size: 1.8em;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    background-color: #fff;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
  }

  th {
    background-color: #f2f2f2;
    font-weight: bold;
  }

  tr:nth-child(even) td {
    background-color: #f9f9f9;
  }

  h1, h2, h3 {
    border-bottom: 1px solid #ccc;
    padding-bottom: 4px;
    margin-top: 2rem;
  }

  pre, code {
    background-color: #f0f0f0;
    padding: 6px;
    border-radius: 4px;
    font-family: monospace;
  }

  table td:first-child,
  table th:first-child {
    width: 30%;
    text-align: left;
  }

  table td:not(:first-child),
  table th:not(:first-child) {
    width: 10%;
    text-align: right;
  }

/* These classes will be added by JavaScript */
.negative {
    color: red;
}

.positive {
    color: green;
}

.hidden {
    display: none;
}

  </style>
</head>
<body>

<div id="companyBanner" class="company-banner"></div>

<div class="tradingview-widget-container hidden" style="margin-bottom: 2rem;">
  <div id="tradingview-mini-chart" class="tradingview-widget-container__widget"></div>
  <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
  {
  "symbol": "BSE:SENSEX", /* Default symbol, will be updated by JS */
  "width": "100%",
  "height": "300",
  "locale": "en",
  "dateRange": "3Y", /* 3 years chart */
  "colorTheme": "light",
  "isTransparent": false,
  "autosize": false,
  "largeChartUrl": ""
}
  </script>
</div>

<div id="content">Loading...</div>

<script>
    // The Apps Script web app URL.
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzy9OkOVsflibkZo5ryhrFoNoSSHhjVYiZzcWX0WuLoJNV9RZXayTCiDwK2BbYZQrNyIQ/exec";

    /**
     * Applies styling to table cells based on their numeric value.
     * This function is called after the markdown is rendered.
     */
    function applyTableStyling() {
      // Find all tables on the page.
      const tables = document.querySelectorAll('table');
      
      if (tables.length === 0) {
        return; // Exit if no tables are found.
      }

      tables.forEach(table => {
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const cells = row.querySelectorAll('td');

          cells.forEach((cell, index) => {
            // Attempt to parse the cell's content as a number.
            const value = parseFloat(cell.textContent.replace(/,/g, ''));
            
            // Check if it's a valid number.
            if (!isNaN(value)) {
              // Format the number with commas using toLocaleString, specifying the Indian locale.
              cell.textContent = value.toLocaleString('en-IN');

              // Apply coloring for specific columns (6 and 7).
              // Columns are 1-indexed for the user, but 0-indexed in the code.
              if (index === 5 || index === 6) {
                if (value < 0) {
                  cell.classList.add('negative');
                } else if (value > 0) {
                  cell.classList.add('positive');
                }
              }
            }
          });
        });
      });
    }

    /**
     * Gets a query parameter from the URL.
     * @param {string} name The name of the parameter.
     * @returns {string|null} The value of the parameter or null.
     */
    function getParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    /**
     * Updates the visibility of the TV chart and syncs the checkbox.
     * @param {boolean} showChart - true to show, false to hide.
     */
    function updateChartVisibility(showChart) {
        if (showChart) {
            tradingviewWidgetContainer.classList.remove('hidden');
        } else {
            tradingviewWidgetContainer.classList.add('hidden');
        }
    }       

    /**
     * Initializes the TV chart preference based on URL parameters or localStorage.
     * Sets default if no preference found.
     * @returns {void}
     */
    function initializeTvChartPreference() {
        // 1. Check for URL query parameter first
        const urlParams = new URLSearchParams(window.location.search);
        const urlPreference = urlParams.get('tvchart');

        if (urlPreference) {
            let showChartFromUrl;
            if (urlPreference.toLowerCase() === 'show') {
                showChartFromUrl = true;
            } else if (urlPreference.toLowerCase() === 'hide') {
                showChartFromUrl = false;
            }

            // If a valid preference was found in the URL, save it and apply it.
            if (showChartFromUrl !== undefined) {
                localStorage.setItem(PREFERENCE_KEY, showChartFromUrl.toString());
                updateChartVisibility(showChartFromUrl);
                // Optionally, clear the URL parameter to prevent persistent overrides on refresh
                // window.history.replaceState({}, document.title, window.location.pathname);
                return showChartFromUrl; // Exit as URL param takes precedence
            }
        }

        // 2. If no valid URL parameter, load from localStorage
        const savedPreference = localStorage.getItem(PREFERENCE_KEY);
        if (savedPreference !== null) {
            const showChart = (savedPreference === 'true');
            updateChartVisibility(showChart);
            return showChart;
        } else {
            // 3. If no localStorage preference, apply default and save it
            localStorage.setItem(PREFERENCE_KEY, DEFAULT_SHOW_CHART.toString());
            updateChartVisibility(DEFAULT_SHOW_CHART);
            return DEFAULT_SHOW_CHART;
        }
    }    

    // Get the company symbol from the URL query parameter.
    const companySymbol = getParam('company');
    const contentDiv = document.getElementById("content");
    const companyBanner = document.getElementById("companyBanner");
    const tradingviewWidgetContainer = document.querySelector(".tradingview-widget-container");
    const tradingviewScript = tradingviewWidgetContainer.querySelector('script');

    // Constants
    const PREFERENCE_KEY = 'showTvChart';
    const DEFAULT_SHOW_CHART = true;    

    // Main execution logic for fetching and rendering content.
    if (companySymbol) {
      //Update Window Title
      document.title = `${companySymbol.toUpperCase()} - AI Analysis`;
      // Update the company banner
      companyBanner.textContent = companySymbol.toUpperCase();

      // Update the TradingView widget symbol
      const tradingViewSymbol = `BSE:${companySymbol.toUpperCase()}`;

      const showTvchart = initializeTvChartPreference();

      if (showTvchart) {
        // We need to re-initialize the TradingView widget script to change the symbol dynamically.
        // A common way to do this is to remove the old script and add a new one.
        tradingviewScript.remove();
        const newTradingviewScript = document.createElement('script');
        newTradingviewScript.type = 'text/javascript';
        newTradingviewScript.src = 'https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js';
        newTradingviewScript.async = true;
        newTradingviewScript.innerHTML = JSON.stringify({
            "symbol": tradingViewSymbol,
            "width": "100%",
            "height": "300",
            "locale": "en",
            "dateRange": "3Y",
            "colorTheme": "light",
            "isTransparent": false,
            "autosize": false,
            "largeChartUrl": ""
        });
        tradingviewWidgetContainer.appendChild(newTradingviewScript);
    }

      contentDiv.innerHTML = "<h1>Loading AI Analysis for " + companySymbol.toUpperCase() + "...</h1>";
      
      const url = `${WEB_APP_URL}?company=${companySymbol}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.ai_analysis) {
            const fullContent = data.ai_analysis;

            // Immediately display a truncated version for quick feedback.
            const partialContent = fullContent.substring(0, 2000);
            contentDiv.innerHTML = marked.parse(partialContent + (fullContent.length > 2000 ? "..." : ""));

            // In the background, fetch the full content and update.
            setTimeout(() => {
              contentDiv.innerHTML = marked.parse(fullContent);
              // Apply styling after the full content is rendered.
              applyTableStyling();
            }, 100); 

          } else {
            contentDiv.innerHTML = `<p style='color:red'>${data.message || 'Error: Could not retrieve analysis.'}</p>`;
          }
        })
        .catch(error => {
          console.error('Error fetching data:', error);
          contentDiv.innerHTML = `<p style='color:red'>An error occurred while fetching the data: ${error.message}</p>`;
        });
    } else {
      companyBanner.textContent = "AI Analysis Viewer";
      contentDiv.innerHTML = "<p style='color:red'>No company symbol provided. Please use a URL parameter like <code>?company=GOOG</code>.</p>";
    }
  </script>
</body>
</html>